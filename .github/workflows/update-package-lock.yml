name: Update lock file

on:
  push:
    branches-ignore:
      - "update-package-lock--**"
    paths:
      - "**/package-lock.json"
  workflow_dispatch:

jobs:
  update-package-lock:
    name: Update lock file
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Replace references in package-lock.json
        run: |
          sed -i "s|${MIRROR_URL}|${UPSTREAM_URL}|" package-lock.json
        env:
          MIRROR_URL: https://artifactory.csin.cz:443/artifactory/api/npm/registry-npmjs-org/
          UPSTREAM_URL: https://registry.npmjs.org/

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore(package-lock): fix package-lock.json on ${{ github.ref_name }}"
          commit-message: "chore(package-lock): fix package-lock.json"
          body: "Fixed references to registry.npmjs.org in the `package-lock.json` file"
          branch: update-package-lock--${{ github.ref_name }}
          delete-branch: true
          labels: bot,package-lock
